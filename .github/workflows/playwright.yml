name: Playwright Tests
on:
  workflow_dispatch:

jobs:
  test:
    name: Run Playwright Tests
    runs-on: ubuntu-latest
    timeout-minutes: 60
    container: 
      image: mcr.microsoft.com/playwright:v1.56.1-noble
      options: --user root
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-node@v4
      with:
        node-version: lts/*
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run Playwright tests
      id: playwright
      run: |
          set +e
          OUTPUT=$(npx playwright test 2>&1)
          EXIT_CODE=$?
          set -e
          
          echo "test_output<<EOF" >> $GITHUB_OUTPUT
          echo "$OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          PASSED=$(echo "$OUTPUT" | grep -oP '\d+(?= passed)' | head -1 || echo "0")
          FAILED=$(echo "$OUTPUT" | grep -oP '\d+(?= failed)' | head -1 || echo "0")
          SKIPPED=$(echo "$OUTPUT" | grep -oP '\d+(?= skipped)' | head -1 || echo "0")
          FLAKY=$(echo "$OUTPUT" | grep -oP '\d+(?= flaky)' | head -1 || echo "0")
          
          DOTS_LINE=$(echo "$OUTPUT" | grep -oP '^[Â·FÃ—Â±TÂ°]+' | head -1 || echo "")
          
          if [ -n "$DOTS_LINE" ]; then
            DOT_PASSED=$(echo "$DOTS_LINE" | grep -o 'Â·' | wc -l)
            DOT_FAILED=$(echo "$DOTS_LINE" | grep -o 'F' | wc -l)
            DOT_RETRY=$(echo "$DOTS_LINE" | grep -o 'Ã—' | wc -l)
            DOT_FLAKY=$(echo "$DOTS_LINE" | grep -o 'Â±' | wc -l)
            DOT_TIMEOUT=$(echo "$DOTS_LINE" | grep -o 'T' | wc -l)
            DOT_SKIPPED=$(echo "$DOTS_LINE" | grep -o 'Â°' | wc -l)
          else
            DOT_PASSED=0
            DOT_FAILED=0
            DOT_RETRY=0
            DOT_FLAKY=0
            DOT_TIMEOUT=0
            DOT_SKIPPED=0
          fi
          
          REPORT_URL=$(echo "$OUTPUT" | grep -oP 'HTML Report is available at: \K.*' || echo "")
          
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
          echo "flaky=$FLAKY" >> $GITHUB_OUTPUT
          echo "dot_passed=$DOT_PASSED" >> $GITHUB_OUTPUT
          echo "dot_failed=$DOT_FAILED" >> $GITHUB_OUTPUT
          echo "dot_retry=$DOT_RETRY" >> $GITHUB_OUTPUT
          echo "dot_flaky=$DOT_FLAKY" >> $GITHUB_OUTPUT
          echo "dot_timeout=$DOT_TIMEOUT" >> $GITHUB_OUTPUT
          echo "dot_skipped=$DOT_SKIPPED" >> $GITHUB_OUTPUT
          echo "report_url=$REPORT_URL" >> $GITHUB_OUTPUT
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          exit $EXIT_CODE
      env:
        CI: true
        CI_COMMIT_BRANCH: ${{ github.ref_name }}
        CT_TOKEN: ${{ secrets.CT_TOKEN }}
        CT_SERVER_URL: ${{ vars.CT_SERVER_URL }}
        HOME: /root
      
    - name: Generate Summary
      if: always()
      run: |
        PASSED="${{ steps.playwright.outputs.passed }}"
        FAILED="${{ steps.playwright.outputs.failed }}"
        SKIPPED="${{ steps.playwright.outputs.skipped }}"
        FLAKY="${{ steps.playwright.outputs.flaky }}"
        DOT_RETRY="${{ steps.playwright.outputs.dot_retry }}"
        DOT_TIMEOUT="${{ steps.playwright.outputs.dot_timeout }}"
        REPORT_URL="${{ steps.playwright.outputs.report_url }}"
        EXIT_CODE="${{ steps.playwright.outputs.exit_code }}"
         
        if [ "$EXIT_CODE" -eq 0 ]; then
          STATUS="âœ… Success"
          STATUS_COLOR="ðŸŸ¢"
        else
          STATUS="âŒ Failed"
          STATUS_COLOR="ðŸ”´"
        fi
        
        TOTAL=$((PASSED + FAILED + SKIPPED))
        
        cat >> $GITHUB_STEP_SUMMARY << EOF
        # ðŸŽ­ Playwright Test Results
        
        ## $STATUS_COLOR Status: $STATUS
        
        ### ðŸ“Š Test Statistics
        
        | Metric | Count | Percentage |
        |--------|-------|------------|
        | Â· Passed | $PASSED | $(awk "BEGIN {printf \"%.1f\", ($PASSED/$TOTAL)*100}")% |
        | F Failed | $FAILED | $(awk "BEGIN {printf \"%.1f\", ($FAILED/$TOTAL)*100}")% |
        | Â° Skipped | $SKIPPED | $(awk "BEGIN {printf \"%.1f\", ($SKIPPED/$TOTAL)*100}")% |
        | **ðŸ“ Total** | **$TOTAL** | **100%** |
        
        EOF
        
        #     
        if [ "$FLAKY" -gt 0 ] || [ "$DOT_RETRY" -gt 0 ] || [ "$DOT_TIMEOUT" -gt 0 ]; then
          cat >> $GITHUB_STEP_SUMMARY << EOF
        ### âš ï¸ Additional Details
        
        | Status | Count | Description |
        |--------|-------|-------------|
        EOF
          
          if [ "$FLAKY" -gt 0 ]; then
            echo "| Â± Flaky | $FLAKY | Passed on retry |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "$DOT_RETRY" -gt 0 ]; then
            echo "| Ã— Retry | $DOT_RETRY | Failed and will be retried |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "$DOT_TIMEOUT" -gt 0 ]; then
            echo "| T Timeout | $DOT_TIMEOUT | Timed out |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        #      
        if [ -n "$REPORT_URL" ]; then
          cat >> $GITHUB_STEP_SUMMARY << EOF
        ### ðŸ“„ Reports
        
        ðŸ”— [View HTML Report]($REPORT_URL)
        
        EOF
        fi
        
        #     
        cat >> $GITHUB_STEP_SUMMARY << 'EOF'
        <details>
        <summary>ðŸ“‹ Full Test Output</summary>
        
        ```
        EOF
        
        echo -e "${{ steps.playwright.outputs.test_output }}" >> $GITHUB_STEP_SUMMARY
        
        cat >> $GITHUB_STEP_SUMMARY << 'EOF'
        ```
        
        </details>
        EOF

