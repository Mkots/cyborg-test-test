name: Playwright Tests
on:
  workflow_dispatch:
    inputs:
      project:
        type: choice
        description: 'Specify the project to test'
        options:
          - 'project-one'
          - 'project-two'
          - 'project-three'
          - 'api-tests'
        required: true
        default: 'project-one'

jobs:
  test:
    name: Run Playwright Tests
    runs-on: ubuntu-latest
    timeout-minutes: 60
    container: 
      image: mcr.microsoft.com/playwright:v1.56.1-noble
      options: --user root
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-node@v4
      with:
        node-version: lts/*
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run Playwright tests
      id: playwright
      run: |
          set +e
          OUTPUT=$(npx playwright test --project=${{ github.event.inputs.project }} 2>&1)
          EXIT_CODE=$?
          set -e
          
          echo "test_output<<EOF" >> $GITHUB_OUTPUT
          echo "$OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          DOTS_LINE=$(echo "$OUTPUT" | grep -oP '^[Â·FÃ—Â±TÂ°]+' | head -1 || echo "")
          
          if [ -n "$DOTS_LINE" ]; then
            DOT_PASSED=$(echo "$DOTS_LINE" | grep -o 'Â·' | wc -l)
            DOT_FAILED=$(echo "$DOTS_LINE" | grep -o 'F' | wc -l)
            DOT_RETRY=$(echo "$DOTS_LINE" | grep -o 'Ã—' | wc -l)
            DOT_FLAKY=$(echo "$DOTS_LINE" | grep -o 'Â±' | wc -l)
            DOT_TIMEOUT=$(echo "$DOTS_LINE" | grep -o 'T' | wc -l)
            DOT_SKIPPED=$(echo "$DOTS_LINE" | grep -o 'Â°' | wc -l)
          else
            DOT_PASSED=0
            DOT_FAILED=0
            DOT_RETRY=0
            DOT_FLAKY=0
            DOT_TIMEOUT=0
            DOT_SKIPPED=0
          fi
          
          REPORT_URL=$(echo "$OUTPUT" | grep -oP 'HTML Report is available at: \K.*' || echo "")
          
          echo "dot_passed=$DOT_PASSED" >> $GITHUB_OUTPUT
          echo "dot_failed=$DOT_FAILED" >> $GITHUB_OUTPUT
          echo "dot_retry=$DOT_RETRY" >> $GITHUB_OUTPUT
          echo "dot_flaky=$DOT_FLAKY" >> $GITHUB_OUTPUT
          echo "dot_timeout=$DOT_TIMEOUT" >> $GITHUB_OUTPUT
          echo "dot_skipped=$DOT_SKIPPED" >> $GITHUB_OUTPUT
          echo "report_url=$REPORT_URL" >> $GITHUB_OUTPUT
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          exit $EXIT_CODE
      env:
        CI: true
        CI_COMMIT_BRANCH: ${{ github.ref_name }}
        CT_TOKEN: ${{ secrets.CT_TOKEN }}
        CT_SERVER_URL: ${{ vars.CT_SERVER_URL }}
        QA_USERNAME: ${{ github.actor }}
        PROJECT: ${{ github.event.inputs.project }}
        HOME: /root
      
    - name: Generate Summary
      if: always()
      run: |
        PASSED="${{ steps.playwright.outputs.dot_passed }}"
        FAILED="${{ steps.playwright.outputs.dot_failed }}"
        SKIPPED="${{ steps.playwright.outputs.dot_skipped }}"
        FLAKY="${{ steps.playwright.outputs.dot_flaky }}"
        RETRY="${{ steps.playwright.outputs.dot_retry }}"
        TIMEOUT="${{ steps.playwright.outputs.dot_timeout }}"
        REPORT_URL="${{ steps.playwright.outputs.report_url }}"
        EXIT_CODE="${{ steps.playwright.outputs.exit_code }}"
         
        if [ "$EXIT_CODE" -eq 0 ]; then
          STATUS="âœ… Success"
          STATUS_COLOR="ðŸŸ¢"
        else
          STATUS="âŒ Failed"
          STATUS_COLOR="ðŸ”´"
        fi

        TOTAL=$((PASSED + FAILED + SKIPPED))

        cat >> $GITHUB_STEP_SUMMARY << EOF
        # ðŸŽ­ Playwright Test Results
        
        ## $STATUS_COLOR Status: $STATUS
        
        ### ðŸ“Š Test Statistics
        
        | Metric | Count | Percentage |
        |--------|-------|------------|
        | Passed | $PASSED | $(awk "BEGIN {printf \"%.1f\", ($PASSED/$TOTAL)*100}")% |
        | Failed | $FAILED | $(awk "BEGIN {printf \"%.1f\", ($FAILED/$TOTAL)*100}")% |
        | Skipped | $SKIPPED | $(awk "BEGIN {printf \"%.1f\", ($SKIPPED/$TOTAL)*100}")% |
        | **ðŸ“ Total** | **$TOTAL** | **100%** |
        
        EOF
        
        #     
        if [ "$FLAKY" -gt 0 ] || [ "$RETRY" -gt 0 ] || [ "$TIMEOUT" -gt 0 ]; then
          cat >> $GITHUB_STEP_SUMMARY << EOF
        ### âš ï¸ Additional Details
        
        | Status | Count | Description |
        |--------|-------|-------------|
        EOF
          
          if [ "$FLAKY" -gt 0 ]; then
            echo "| Flaky | $FLAKY | Passed on retry |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "$RETRY" -gt 0 ]; then
            echo "| Retry | $RETRY | Failed and will be retried |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "$TIMEOUT" -gt 0 ]; then
            echo "| Timeout | $TIMEOUT | Timed out |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        #      
        if [ -n "$REPORT_URL" ]; then
          cat >> $GITHUB_STEP_SUMMARY << EOF
        ### ðŸ“„ Reports
        
        ðŸ”— [View HTML Report]($REPORT_URL)
        
        EOF
        fi
        
        #     
        cat >> $GITHUB_STEP_SUMMARY << 'EOF'
        <details>
        <summary>ðŸ“‹ Full Test Output</summary>
        
        ```
        EOF
        
        echo -e "${{ steps.playwright.outputs.test_output }}" >> $GITHUB_STEP_SUMMARY
        
        cat >> $GITHUB_STEP_SUMMARY << 'EOF'
        ```
        
        </details>
        EOF

